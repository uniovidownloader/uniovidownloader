<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnioviDownloader - Conversor ICS a PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5a27, #4a7c59);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #2d5a27;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #4a7c59;
            font-size: 1.2em;
            opacity: 0.8;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .instructions-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #4a7c59;
        }

        .instructions-section h3 {
            color: #2d5a27;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions-content p {
            margin-bottom: 12px;
            color: #495057;
            line-height: 1.6;
            font-size: 1em;
        }

        .instructions-content p:last-child {
            margin-bottom: 0;
        }

        .instructions-content strong {
            color: #2d5a27;
            font-weight: 600;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #4a7c59, #2d5a27);
            color: white;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(45, 90, 39, 0.3);
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(45, 90, 39, 0.4);
        }

        .file-name {
            margin-top: 10px;
            color: #4a7c59;
            font-weight: 500;
        }

        .view-options {
            margin: 30px 0;
        }

        .view-options h3 {
            color: #2d5a27;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .radio-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-option label {
            display: block;
            padding: 12px 25px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #495057;
        }

        .radio-option input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #4a7c59, #2d5a27);
            color: white;
            border-color: #2d5a27;
            transform: scale(1.05);
        }

        .convert-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4a7c59, #2d5a27);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 8px 20px rgba(45, 90, 39, 0.3);
        }

        .convert-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(45, 90, 39, 0.4);
        }

        .convert-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2d5a27;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-card {
                padding: 20px;
            }
            
            .radio-group {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>UnioviDownloader</h1>
        </div>

        <div class="main-card">
            <div class="instructions-section">
                <h3>游늶 Instrucciones de uso</h3>
                <div class="instructions-content">
                    <p><strong>Paso 1:</strong> Accede al SIES (Sistema de Informaci칩n de Estudiantes) de la Universidad de Oviedo</p>
                    <p><strong>Paso 2:</strong> Busca y descarga tu archivo de calendario en formato .ics utilizando el enlace proporcionado en el SIES</p>
                    <p><strong>Paso 3:</strong> Sube el archivo .ics descargado a esta aplicaci칩n usando el bot칩n de abajo</p>
                    <p><strong>Paso 4:</strong> Selecciona el tipo de vista deseada (diaria o semanal) y genera tu PDF</p>
                </div>
            </div>

            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".ics" />
                    <div class="file-input-button">
                        游늰 Seleccionar archivo ICS
                    </div>
                </div>
                <div id="fileName" class="file-name"></div>
            </div>

            <div class="view-options">
                <h3>Selecciona el tipo de vista:</h3>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="daily" name="viewType" value="daily" checked />
                        <label for="daily">Vista Diaria</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="weekly" name="viewType" value="weekly" />
                        <label for="weekly">Vista Semanal</label>
                    </div>
                </div>
            </div>

            <button id="convertButton" class="convert-button" disabled>
                Convertir a PDF
            </button>

            <div id="status" class="status" style="display: none;"></div>
        </div>

        <div style="text-align: center; margin-top: 20px; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
            Esta aplicaci칩n no pertenece a la Universidad de Oviedo
        </div>
    </div>

    <script>
        let icsData = null;
        let events = [];

        // Referencias a elementos del DOM
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const convertButton = document.getElementById('convertButton');
        const status = document.getElementById('status');

        // Event listeners
        fileInput.addEventListener('change', handleFileSelect);
        convertButton.addEventListener('click', convertToPDF);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.ics')) {
                fileName.textContent = `Archivo seleccionado: ${file.name}`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    icsData = e.target.result;
                    events = parseICS(icsData);
                    convertButton.disabled = false;
                    showStatus('Archivo cargado correctamente. ' + events.length + ' eventos encontrados.', 'success');
                };
                reader.readAsText(file);
            } else {
                showStatus('Por favor, selecciona un archivo .ics v치lido.', 'error');
                convertButton.disabled = true;
            }
        }

        function parseICS(icsContent) {
            const events = [];
            const lines = icsContent.split('\n');
            let currentEvent = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.dtstart && currentEvent.summary) {
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        const key = line.substring(0, colonIndex).split(';')[0];
                        const value = line.substring(colonIndex + 1);

                        switch (key) {
                            case 'SUMMARY':
                                currentEvent.summary = value;
                                break;
                            case 'DTSTART':
                                currentEvent.dtstart = parseDate(value);
                                break;
                            case 'DTEND':
                                currentEvent.dtend = parseDate(value);
                                break;
                            case 'LOCATION':
                                currentEvent.location = value;
                                break;
                            case 'DESCRIPTION':
                                currentEvent.description = value;
                                break;
                        }
                    }
                }
            }

            return events.sort((a, b) => a.dtstart - b.dtstart);
        }

        function parseDate(dateString) {
            if (dateString.length === 8) {
                // Formato YYYYMMDD
                const year = parseInt(dateString.substring(0, 4));
                const month = parseInt(dateString.substring(4, 6)) - 1;
                const day = parseInt(dateString.substring(6, 8));
                return new Date(year, month, day);
            } else if (dateString.length >= 15) {
                // Formato YYYYMMDDTHHMMSS
                const year = parseInt(dateString.substring(0, 4));
                const month = parseInt(dateString.substring(4, 6)) - 1;
                const day = parseInt(dateString.substring(6, 8));
                const hour = parseInt(dateString.substring(9, 11));
                const minute = parseInt(dateString.substring(11, 13));
                const second = parseInt(dateString.substring(13, 15));
                return new Date(year, month, day, hour, minute, second);
            }
            return new Date(dateString);
        }

        function convertToPDF() {
            if (!events.length) {
                showStatus('No hay eventos para convertir.', 'error');
                return;
            }

            showStatus('Generando PDF...', 'info');
            convertButton.disabled = true;
            convertButton.innerHTML = '<span class="loading"></span>Generando PDF...';

            const viewType = document.querySelector('input[name="viewType"]:checked').value;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');
                
                switch (viewType) {
                    case 'daily':
                        generateDailyView(doc);
                        break;
                    case 'weekly':
                        generateWeeklyView(doc);
                        break;
                }

                doc.save('calendario.pdf');
                showStatus('PDF generado exitosamente.', 'success');
            } catch (error) {
                console.error('Error generando PDF:', error);
                showStatus('Error al generar el PDF: ' + error.message, 'error');
            } finally {
                convertButton.disabled = false;
                convertButton.innerHTML = 'Convertir a PDF';
            }
        }

        function generateDailyView(doc) {
            const eventsByDate = groupEventsByDate(events);
            let isFirstPage = true;

            Object.keys(eventsByDate).forEach(dateKey => {
                if (!isFirstPage) {
                    doc.addPage();
                }
                isFirstPage = false;

                const date = new Date(dateKey);
                const dayEvents = eventsByDate[dateKey];

                // Encabezado
                doc.setFillColor(45, 90, 39);
                doc.rect(0, 0, 297, 25, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('UnioviDownloader - Vista Diaria', 15, 16);
                
                doc.setFontSize(14);
                doc.text(formatDate(date), 200, 16);

                // Tabla de eventos
                let yPos = 40;
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                
                // Encabezados de tabla
                doc.setFillColor(74, 124, 89);
                doc.rect(15, yPos, 267, 10, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.text('Hora', 20, yPos + 7);
                doc.text('Asignatura', 70, yPos + 7);
                doc.text('Lugar', 200, yPos + 7);
                
                yPos += 15;

                dayEvents.forEach((event, index) => {
                    if (yPos > 190) {
                        doc.addPage();
                        yPos = 40;
                        
                        // Repetir encabezados
                        doc.setFillColor(74, 124, 89);
                        doc.rect(15, yPos, 267, 10, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFont(undefined, 'bold');
                        doc.text('Hora', 20, yPos + 7);
                        doc.text('Asignatura', 70, yPos + 7);
                        doc.text('Lugar', 200, yPos + 7);
                        
                        yPos += 15;
                    }

                    // Alternar colores de fila
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.rect(15, yPos - 5, 267, 12, 'F');
                    }

                    doc.setTextColor(51, 51, 51);
                    doc.setFont(undefined, 'normal');
                    
                    const startTime = formatTime(event.dtstart);
                    const endTime = event.dtend ? formatTime(event.dtend) : '';
                    const timeString = endTime ? `${startTime} - ${endTime}` : startTime;
                    
                    const subjectWithType = getSubjectWithType(event.summary || 'Sin asignatura', event.description);
                    
                    doc.text(timeString, 20, yPos + 2);
                    doc.text(truncateText(subjectWithType, 45), 70, yPos + 2);
                    doc.text(truncateLocation(event.location || 'Sin lugar', 35), 200, yPos + 2);
                    
                    yPos += 12;
                });

                // Pie de p치gina
                addFooter(doc);
            });
        }

        function generateWeeklyView(doc) {
            const eventsByWeek = groupEventsByWeek(events);
            let isFirstPage = true;

            Object.keys(eventsByWeek).forEach(weekKey => {
                if (!isFirstPage) {
                    doc.addPage();
                }
                isFirstPage = false;

                const weekEvents = eventsByWeek[weekKey];
                const weekStart = new Date(weekKey);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 4); // Solo hasta viernes

                // Encabezado
                doc.setFillColor(45, 90, 39);
                doc.rect(0, 0, 297, 25, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('UnioviDownloader - Vista Semanal', 15, 16);
                
                doc.setFontSize(12);
                doc.text(`${formatDate(weekStart)} - ${formatDate(weekEnd)}`, 160, 16);

                // Tabla semanal - Solo lunes a viernes
                let yPos = 40;
                const dayWidth = 53; // M치s ancho al tener solo 5 d칤as
                const days = ['Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes'];
                
                // Encabezados de d칤as
                doc.setFillColor(74, 124, 89);
                doc.rect(15, yPos, 265, 12, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                days.forEach((day, index) => {
                    doc.text(day, 20 + (index * dayWidth), yPos + 8);
                });
                
                yPos += 17;

                // Eventos por d칤a - Solo de lunes a viernes
                const workdayEvents = weekEvents.slice(0, 5); // Solo lunes a viernes
                const maxEventsPerDay = Math.max(...workdayEvents.map(dayEvents => dayEvents ? dayEvents.length : 0));
                
                for (let eventIndex = 0; eventIndex < maxEventsPerDay; eventIndex++) {
                    if (yPos > 170) {
                        doc.addPage();
                        yPos = 40;
                        
                        // Repetir encabezados en nueva p치gina
                        doc.setFillColor(74, 124, 89);
                        doc.rect(15, yPos, 265, 12, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFont(undefined, 'bold');
                        days.forEach((day, index) => {
                            doc.text(day, 20 + (index * dayWidth), yPos + 8);
                        });
                        
                        yPos += 17;
                    }

                    workdayEvents.forEach((dayEvents, dayIndex) => {
                        const event = dayEvents ? dayEvents[eventIndex] : null;
                        
                        if (event) {
                            const x = 20 + (dayIndex * dayWidth);
                            const cellHeight = 25;
                            
                            // Fondo del evento
                            doc.setFillColor(248, 249, 250);
                            doc.rect(x - 2, yPos, dayWidth - 2, cellHeight, 'F');
                            
                            doc.setTextColor(51, 51, 51);
                            doc.setFontSize(8);
                            doc.setFont(undefined, 'bold');
                            
                            const time = formatTime(event.dtstart);
                            const endTime = event.dtend ? ` - ${formatTime(event.dtend)}` : '';
                            doc.text(time + endTime, x, yPos + 5);
                            
                            doc.setFont(undefined, 'normal');
                            const subjectWithType = getSubjectWithType(event.summary || '', event.description);
                            doc.text(truncateText(subjectWithType, 18), x, yPos + 10);
                            doc.text(truncateLocation(event.location || '', 18), x, yPos + 15);
                        }
                    });
                    
                    yPos += 30;
                }

                // Pie de p치gina
                addFooter(doc);
            });
        }

        function generateMonthlyView(doc) {
            // Funci칩n eliminada - ya no se usa la vista mensual
        }

        function generateMonthCalendar(doc, monthDate, events) {
            // Funci칩n eliminada - ya no se usa la vista mensual
        }

        function addFooter(doc) {
            // Pie de p치gina
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.setFont(undefined, 'normal');
            doc.text('Esta aplicaci칩n no pertenece a la Universidad de Oviedo', 148, 200, { align: 'center' });
        }

        function groupEventsByDate(events) {
            const grouped = {};
            events.forEach(event => {
                const date = new Date(event.dtstart);
                
                // Excluir s치bados (6) y domingos (0)
                if (date.getDay() === 0 || date.getDay() === 6) {
                    return;
                }
                
                const dateKey = formatDateKey(event.dtstart);
                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(event);
            });
            return grouped;
        }

        function groupEventsByWeek(events) {
            const grouped = {};
            events.forEach(event => {
                const date = new Date(event.dtstart);
                
                // Excluir s치bados (6) y domingos (0)
                if (date.getDay() === 0 || date.getDay() === 6) {
                    return;
                }
                
                const monday = new Date(date);
                monday.setDate(date.getDate() - (date.getDay() === 0 ? 6 : date.getDay() - 1));
                
                const weekKey = formatDateKey(monday);
                if (!grouped[weekKey]) {
                    grouped[weekKey] = Array(5).fill().map(() => []); // Solo 5 d칤as laborables
                }
                
                const dayIndex = date.getDay() - 1; // Lunes = 0, Viernes = 4
                if (dayIndex >= 0 && dayIndex < 5) { // Solo d칤as laborables
                    grouped[weekKey][dayIndex].push(event);
                }
            });
            return grouped;
        }

        function groupEventsByMonth(events) {
            // Funci칩n eliminada - ya no se usa la vista mensual
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatMonth(date) {
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long'
            });
        }

        function formatTime(date) {
            return date.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function abbreviateLocation(text) {
            if (!text) return '';
            
            const locationAbbreviations = {
                'aula': 'Au',
                'sala microescopio': 'S. Micro',
                'sala de microescopio': 'S. Micro',
                'sala microscopio': 'S. Micro',
                'sala diseccion': 'S. Disec',
                'sala de diseccion': 'S. Disec',
                'sala disecci칩n': 'S. Disec',
                'sala de disecci칩n': 'S. Disec',
                'aula inf': 'Au. Inf',
                'aula informatica': 'Au. Inf',
                'aula inform치tica': 'Au. Inf',
                'laboratorio': 'Lab',
                'lab. docencia': 'Lab. Doc',
                'laboratorio docencia': 'Lab. Doc',
                'laboratorio de docencia': 'Lab. Doc',
                's. grados': 'S. Grad',
                'sala grados': 'S. Grad',
                'sala de grados': 'S. Grad'
            };
            
            let result = text.toLowerCase();
            
            // Buscar coincidencias y reemplazar
            for (const [fullName, abbrev] of Object.entries(locationAbbreviations)) {
                const regex = new RegExp(fullName, 'gi');
                result = result.replace(regex, abbrev);
            }
            
            // Capitalizar primera letra de cada palabra
            return result.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function getSubjectWithType(summary, description) {
            const abbreviated = abbreviateSubject(summary);
            const type = extractActivityType(summary, description);
            return type ? `${abbreviated} (${type})` : abbreviated;
        }

        function extractActivityType(summary, description) {
            const text = (summary + ' ' + (description || '')).toLowerCase();
            
            if (text.includes('pr치ctica') || text.includes('practica') || 
                text.includes('pr치cticas') || text.includes('practicas') ||
                text.includes('laboratorio') || text.includes('lab')) {
                return 'PL';
            }
            if (text.includes('teor칤a') || text.includes('teoria') || 
                text.includes('te칩rica') || text.includes('teorica') ||
                text.includes('magistral') || text.includes('clase magistral')) {
                return 'TE';
            }
            if (text.includes('problema') || text.includes('problemas') ||
                text.includes('ejercicio') || text.includes('ejercicios') ||
                text.includes('pa ') || text.includes(' pa ')) {
                return 'PA';
            }
            if (text.includes('tutoria') || text.includes('tutor칤a') || 
                text.includes('tutorial') || text.includes('tg ') || 
                text.includes(' tg ') || text.includes('grupo peque침o')) {
                return 'TG';
            }
            
            return '';
        }

        function abbreviateSubject(text) {
            if (!text) return '';
            
            const abbreviations = {
                'bioqu칤mica': 'Bioq',
                'bioquimica': 'Bioq',
                'anatom칤a general': 'Anat. Gral',
                'anatomia general': 'Anat. Gral',
                'biologia celular e histologia humana': 'Biol',
                'biolog칤a celular e histolog칤a humana': 'Biol',
                'epidemiologia': 'Epid',
                'epidemiolog칤a': 'Epid',
                'introduccion a la medicina, documentacion': 'Intr. Med',
                'introducci칩n a la medicina, documentaci칩n': 'Intr. Med',
                'introduccion a la medicina': 'Intr. Med',
                'introducci칩n a la medicina': 'Intr. Med',
                'anatom칤a del aparato locomotor': 'Anat. Loc',
                'anatomia del aparato locomotor': 'Anat. Loc',
                'gen칠tica': 'Gene',
                'genetica': 'Gene',
                'fisiolog칤a general': 'Fisiol',
                'fisiologia general': 'Fisiol',
                'psicologia medica': 'Psico',
                'psicolog칤a m칠dica': 'Psico'
            };
            
            const lowerText = text.toLowerCase();
            for (const [fullName, abbrev] of Object.entries(abbreviations)) {
                if (lowerText.includes(fullName)) {
                    return abbrev;
                }
            }
            
            return text;
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            const abbreviated = abbreviateSubject(text);
            return abbreviated.length > maxLength ? abbreviated.substring(0, maxLength - 3) + '...' : abbreviated;
        }

        function truncateLocation(text, maxLength) {
            if (!text) return '';
            const abbreviated = abbreviateLocation(text);
            return abbreviated.length > maxLength ? abbreviated.substring(0, maxLength - 3) + '...' : abbreviated;
        }

        function extractGroup(text) {
            if (!text) return '';
            const groupMatch = text.match(/grupo?\s*:?\s*([A-Za-z0-9]+)/i);
            if (groupMatch) return groupMatch[1];
            
            const groupMatch2 = text.match(/([0-9]+[A-Za-z]?)\s*$/) || text.match(/\b([A-Z][0-9]+)\b/);
            return groupMatch2 ? groupMatch2[1] : '';
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>